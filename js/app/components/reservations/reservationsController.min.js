F5App.app.controller("reservationController",["$scope","$rootScope","$timeout","$http",function(d,c,g,f){d.timesForReservations="08-09 09-10 10-11 11-12 12-13 13-14 14-15 15-16 16-17 17-18 18-19 19-20 20-21 21-22 22-23 23-24".split(" ");d.times="08:00 a.m.;09:00 a.m.;10:00 a.m.;11:00 a.m.;12:00 m.d;01:00 p.m.;02:00 p.m.;03:00 p.m.;04:00 p.m.;05:00 p.m.;06:00 p.m.;07:00 p.m.;08:00 p.m.;09:00 p.m.;10:00 p.m.;11:00 p.m.".split(";");d.roles={Admin:"1",Dependiente:"2"};c.loadReservations=function(){angular.element("#loading-modal").modal("show");
angular.element("#dailyResevations").hide();angular.element(".day div.active").length?(angular.element(".day div.active").parent().addClass("active"),angular.element(".day div.active").parents(".days_row").addClass("active")):(angular.element(".day div").first().addClass("active"),angular.element(".day div").first().parent().addClass("active"),angular.element(".day div").first().parents(".days_row").addClass("active"));var a=angular.element(".day div.active").text();angular.element("#day").val(a);
var e=angular.element("#calendar .days_row.active .day").index(angular.element("#calendar .days_row.active .day.active"));angular.element("#currentDay").html(angular.element("#calendar .days_head .head:eq("+e+")").text()+" "+a);a={method:"POST",url:F5App.base_url+"getReservationByDay",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(d.getDataForTemporaryReservation()),cache:!1};f(a).success(function(a,b,e,c){d.reservations=d.sortReservations(angular.fromJson(a));angular.element("#loading-modal").modal("hide");
angular.element("#dailyResevations").show()}).error(function(a,b,e,d){})};d.loadPitchsPagination=function(){var a={method:"POST",url:F5App.base_url+"getPitchByGroup",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param({group:d.getGroup()}),cache:!1};f(a).success(function(a,c,b,h){d.pitchs=angular.fromJson(a);angular.element("#pitchs").show()}).error(function(a,d,b,c){});d.pitchValue=angular.element("#pitch").val()};d.sortReservations=function(a){for(var e=[],c=[],b=0;b<d.timesForReservations.length;b++)e[b]=
[];for(b=0;b<d.timesForReservations.length;b++){for(c=0;c<a.length;c++)a[c].reservation_time===d.timesForReservations[b]&&e[b].push(a[c]);1==e[b].length&&1!=e[b][0].type_reservation&&1==e[b][0].team_id?e[b][1]={}:1==e[b].length&&1!=e[b][0].type_reservation&&2==e[b][0].team_id?(e[b][1]=e[b][0],e[b][0]={}):0==e[b].length?(e[b][0]={},e[b][1]={}):2==e[b].length&&1!=e[b][0].type_reservation&&2==e[b][0].team_id&&1==e[b][1].team_id&&(c=e[b][0],e[b][0]=e[b][1],e[b][1]=c)}return e};d.getGroup=function(){var a=
null;$.ajax({type:"POST",url:F5App.base_url+"getGroup",data:{group_name:angular.element("#group").val()||window.location.pathname.replace("/","").replace(/\/$/,"").split("/")[1]},async:!1,success:function(e){a=jQuery.parseJSON(e)[0].id}});return a};d.getPitch=function(){return angular.element("#pitch").val()||window.location.pathname.replace("/","").replace(/\/$/,"").split("/")[2]};c.getDataForTemporaryReservation=function(){return{reservation_year:angular.element("#year").val(),reservation_month:angular.element("#month").val(),
reservation_day:angular.element("#day").val(),group_id:d.getGroup(),pitch_id:d.getPitch(),team_id:angular.element("#team_id").val(),reservation_time:angular.element("#reservation_time").val(),id_user:angular.element("#id_user").val()?angular.element("#id_user").val():"0"}};c.getDataForReservation=function(){var a=d.getDataForTemporaryReservation();a.name=c.fields.name.capitalize();a.lastname=c.fields.lastname1.capitalize()+" "+c.fields.lastname2.capitalize();a.phone=c.fields.phone;a.email=c.fields.email;
a.type_reservation=c.fields.typeReservation;a.referee_required=d.fields.setReferee?"1":"0";a.setPitchAllWeeks=!!c.fields.setPitchAllWeeks;return a};c.setStateTemporaryReservation=function(a){a={method:"POST",url:F5App.base_url+"setTemporaryReservationState",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(a),cache:!1};f(a).success(function(a,c,b,d){}).error(function(a,c,b,d){})};d.getDateFromServer=function(){$.ajax({type:"POST",url:F5App.base_url+"getDateFromServer",async:!1,
success:function(a){g(function(){d.dateFromServer=Date.parse(a)?a:a.replace(/-/g,"/")+" GMT"})}})};c.getRates=function(){f({method:"POST",url:F5App.base_url+"getRates",headers:{"Content-Type":"application/x-www-form-urlencoded"},cache:!1}).success(function(a,e,d,b){c.rates=angular.fromJson(a)}).error(function(a,e,c,b){})};c.isDateForBookingValid=function(){return new Date(angular.element("#year").val(),angular.element("#month").val()-1,angular.element("#day").val(),"23","59","59")>new Date(d.dateFromServer)};
c.isAdminUser=function(){return!!angular.element("#isAdminUser").val()&&/admin/.test(location.href)};c.getRol=function(){return angular.element("#rol_user").val()};c.isRol=function(a){return d.roles[a]};c.getGroupUser=function(){return angular.element("#group_user").val()};c.calculateDayPerWeek=function(){var a=[],e,c,b;a.push([angular.element("#day").val(),angular.element("#month").val(),angular.element("#year").val()]);for(var d=1;365>=d;d++)e=new Date(angular.element("#year").val(),angular.element("#month").val()-
1,angular.element("#day").val()),b=new Date(angular.element("#year").val(),angular.element("#month").val()-1,angular.element("#day").val()),b.setDate(e.getDate()+d),0==d%7&&(e=b.getDate().toString(),c=(b.getMonth()+1).toString(),b=b.getFullYear().toString(),a.push([e,c,b]));return a};c.sendEmail=function(a){angular.element("#sending-email-modal").modal("show");a={method:"POST",url:F5App.base_url+"sendEmail",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(a),cache:!1};f(a).success(function(a,
c,b,f){angular.element("#sending-email-modal").modal("hide");d.loadReservations()}).error(function(a,c,b,d){})};c.sendSMS=function(a){angular.element("#sending-sms-modal").modal("show");a={method:"POST",url:F5App.base_url+"sendSMS",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(a),cache:!1};f(a).success(function(a,c,b,f){angular.element("#sending-sms-modal").modal("hide");d.loadReservations()}).error(function(a,c,b,d){})};c.getCorrectTimeReservation=function(a){return d.times[d.timesForReservations.indexOf(a)]};
angular.element(window).bind("beforeunload",function(a){if((/admin/.test(location.href)||/reservaciones/.test(location.href))&&!F5App.leaveSafelyPage){var e=c.getDataForTemporaryReservation();e.state="3";d.setStateTemporaryReservation(e);return(a||window.event).returnValue=" "}});c.fields={name:"",lastname1:"",lastname2:"",phone:"",email:"",typeReservation:"",setReferee:"",password:"",confirmation:"",client:"",typeReservationSelected:"",setPitchAllWeeks:"",stepReservation:1,accountName:""};d.loadReservations();
d.loadPitchsPagination()}]);angular.element(document).ready(function(){angular.element("body").delegate("a","click",function(){F5App.leaveSafelyPage=!0});angular.element("#calendar .header").on("mouseenter",function(){angular.element(".days_head, .days_row").show()});angular.element("#currentDate").on("click",function(){angular.element(".days_head, .days_row").show()});angular.element("#calendar").on("mouseleave",function(){angular.element(".days_head, .days_row").hide()})});